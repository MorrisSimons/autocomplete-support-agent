(this.webpackJsonpstreamlit_copilot=this.webpackJsonpstreamlit_copilot||[]).push([[0],{14:function(t,e,o){"use strict";o.r(e);var s=o(1),n=o.n(s),r=o(5),i=o.n(r),a=o(0),c=o(2),l=o(3);const u=["prompt_template","api_key","height","fontFamily","border","text","question_title"],p=["prompt_template","api_url","api_key","height","fontFamily","border","text","question_title"];class h extends l.b{constructor(){super(...arguments),this.userTextarea=null,this.suggestionTextarea=null,this.state={text:"",suggestion:"",isFocused:!1,textAreaIsFocused:!1,requestsThisMinute:0,currentMinute:Math.floor(Date.now()/6e4),totalRequests:0,successfulRequests:0,failedRequests:0,inputCost:0,outputCost:0,totalCost:0,debounceTimer:null},this.render=()=>{const{theme:t}=this.props;if(!t)return n.a.createElement("div",null,"Theme is undefined, please check streamlit version.");const e=this.props.args.height,o=t.font,s=e+"px",r="1px solid "+t.primaryColor,i="1px solid "+t.secondaryBackgroundColor;return n.a.createElement("div",null,n.a.createElement("div",{style:{fontSize:"1em",color:t.textColor,marginBottom:"0.5em",padding:"0.5em",backgroundColor:t.backgroundColor,borderRadius:"0.3em",border:"1px solid "+t.secondaryBackgroundColor,display:"flex",justifyContent:"space-between",alignItems:"center"}},n.a.createElement("div",null,n.a.createElement("strong",null,"API Stats:")," Total: ",this.state.totalRequests," | \u2705 Success: ",this.state.successfulRequests," | \u274c Failed: ",this.state.failedRequests," |","Requests this per minute / limit: ",this.state.requestsThisMinute," / ",this.props.args.rpm_limit,n.a.createElement("br",null),n.a.createElement("strong",null,"Cost:")," Input: $",this.state.inputCost.toFixed(6)," | Output: $",this.state.outputCost.toFixed(6)," | Total: $",this.state.totalCost.toFixed(6)),n.a.createElement("button",{onClick:this.resetCounters,style:{fontSize:"0.7em",padding:"0.2em 0.5em",backgroundColor:t.primaryColor,color:"white",border:"none",borderRadius:"0.3em",cursor:"pointer"},title:"Reset counters"},"\ud83d\udd04 Reset")),n.a.createElement("div",{tabIndex:0,style:{height:s,width:"auto",border:this.state.isFocused?r:i,borderRadius:"0.5em",overflowY:"scroll",overflowX:"hidden",position:"relative",backgroundColor:t.secondaryBackgroundColor},onFocus:this._onFocus,onBlur:this._onBlur},n.a.createElement("textarea",{style:{marginLeft:"0.5em",fontFamily:o,marginTop:"0.2em",whiteSpace:"pre-wrap",width:"calc(100% - 1.2em)",height:"100%",border:"none",outline:"none",position:"absolute",backgroundColor:"transparent",color:"light"===t.base?"rgba(41,51,62,0.5)":"rgba(255,255,255,0.5)",padding:"0"},value:this.state.suggestion,readOnly:!0,ref:t=>{this.suggestionTextarea=t}}),n.a.createElement("textarea",{style:{marginLeft:"0.5em",fontFamily:o,marginTop:"0.2em",whiteSpace:"pre-wrap",width:"calc(100% - 1.2em)",height:"100%",border:"none",outline:"none",position:"absolute",backgroundColor:"transparent",color:t.textColor,padding:"0"},value:this.state.text,onChange:this.onChange,onKeyDown:this.onKeyDown,onBlur:this._onTextAreaBlur,onScroll:this.onScroll,ref:t=>{this.userTextarea=t}})))},this.onScroll=()=>{this.forceUpdate()},this.onChange=t=>{const e=t.target.value;this.setState({text:e,suggestion:""}),null!==this.state.debounceTimer&&window.clearTimeout(this.state.debounceTimer);const o=window.setTimeout(()=>{if(""!==e.trim()){const t=this.props.args.api_url;this.callApi(e,t).then(t=>{""!==this.state.text.trim()&&this.setState({suggestion:this.state.text+t})})}},500);this.setState({debounceTimer:o})},this.onKeyDown=t=>{"Tab"===t.key&&(t.preventDefault(),this.setState(t=>({text:t.suggestion,suggestion:""}),()=>{const t={target:{value:this.state.text}};this.onChange(t)}))},this._onTextAreaBlur=()=>{this.setState({textAreaIsFocused:!1},()=>{l.a.setComponentValue(this.state.text),this.setState({suggestion:""})})},this._onFocus=()=>{this.setState({isFocused:!0})},this._onBlur=()=>{this.setState({isFocused:!1})},this.resetCounters=()=>{this.setState({totalRequests:0,successfulRequests:0,failedRequests:0,requestsThisMinute:0,inputCost:0,outputCost:0,totalCost:0})},this.abortController=new AbortController,this.executeToolCalls=async t=>{const e=[];for(const n of t){var o,s;const t=null===(o=n.function)||void 0===o?void 0:o.name,r=JSON.parse((null===(s=n.function)||void 0===s?void 0:s.arguments)||"{}");if(console.log("Executing tool: ".concat(t," with args:"),r),"search_knowledge_base"===t){const o=await this.executeTool(t,r);e.push(o)}else e.push("Unknown tool: ".concat(t))}return e},this.executeTool=async(t,e)=>{if("search_knowledge_base"===t){let t="";t="string"===typeof e.query?e.query:e.query&&"object"===typeof e.query?e.query.toString()||"":String(e.query||""),console.log('Processing query: "'.concat(t,'"'));const s=this.props.args.pinecone_api_key,n=this.props.args.pinecone_index_name,r=this.props.args.openai_api_key;if(s&&n&&r)try{const e=await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{Authorization:"Bearer ".concat(r),"Content-Type":"application/json"},body:JSON.stringify({model:this.props.args.embedding_model||"text-embedding-ada-002",input:t})});if(!e.ok)throw new Error("OpenAI API error: ".concat(e.status));const o=(await e.json()).data[0].embedding,i=(this.props.args.pinecone_environment,this.props.args.pinecone_host||"https://api.pinecone.io");let a;a=i.includes("svc.")&&i.includes(".pinecone.io")?"https://".concat(i,"/query"):"".concat(i,"/indexes/").concat(n,"/query"),console.log("Pinecone query URL: ".concat(a));const c=await fetch(a,{method:"POST",headers:{"Api-Key":s,"Content-Type":"application/json"},body:JSON.stringify({vector:o,topK:this.props.args.search_top||3,includeMetadata:!0})});if(!c.ok)throw new Error("Pinecone API error: ".concat(c.status));const l=await c.json();if(l.matches&&l.matches.length>0){const t=l.matches.map(t=>{var e,o;return(null===(e=t.metadata)||void 0===e?void 0:e.text)||(null===(o=t.metadata)||void 0===o?void 0:o.content)||"No content"}).filter(t=>"No content"!==t);if(t.length>0)return"Found ".concat(t.length," relevant results:\n").concat(t.join("\n\n"))}return""}catch(o){return console.error("Pinecone search error:",o),""}return""}return""},this.makeFollowUpCall=async(t,e,o)=>{const s="Based on search results: ".concat(o.join("\n"),'\n\nComplete: "').concat(e,'"'),n=this.props.args,{prompt_template:r,api_key:i,height:l,fontFamily:p,border:h,text:d,question_title:m}=n,g=Object(c.a)(n,u),f=(r.replace("{text}",d||"").replace("{question_title}",m||""),"chat"===this.props.args.api_format||t.includes("/chat/completions"));let b;if(f){const t={};g.model&&(t.model=g.model),g.max_tokens&&(t.max_tokens=g.max_tokens),g.temperature&&(t.temperature=g.temperature),g.top_p&&(t.top_p=g.top_p),g.stop&&(t.stop=g.stop),b=Object(a.a)(Object(a.a)({messages:[{role:"user",content:s}]},t),{},{stream:!1})}else b=Object(a.a)(Object(a.a)({prompt:s},g),{},{echo:!1});const x={"Content-Type":"application/json"};i&&(x.Authorization="Bearer ".concat(i));try{const e=await fetch(t,{method:"POST",headers:x,body:JSON.stringify(b),signal:this.abortController.signal});if(!e.ok)throw new Error("HTTP error! status: ".concat(e.status));const o=await e.json();let s="";if(f&&o.choices&&o.choices[0]&&o.choices[0].message)s=o.choices[0].message.content;else{if(!(o.choices&&o.choices[0]&&o.choices[0].text))return console.error("Unexpected response format:",o),"";s=o.choices[0].text}let n="";const r=s.indexOf("<answer>");if(-1!==r){n=s.substring(r+8);const t=n.indexOf("</answer>");-1!==t&&(n=n.substring(0,t))}else n=s;return n}catch(y){return console.error("Follow-up call error:",y),""}},this.callApi=async(t,e)=>{if(this.abortController.abort(),this.abortController=new AbortController,""===t.trim())return"";const o=Math.floor(Date.now()/6e4);if(o>this.state.currentMinute)this.setState({currentMinute:o,requestsThisMinute:0});else if(this.state.requestsThisMinute>this.props.args.rpm_limit)return new Promise(o=>{setTimeout(()=>{o(this.callApi(t,e))},1e3)});const s=this.props.args,{prompt_template:n,api_url:r,api_key:i,height:l,fontFamily:u,border:h,text:d,question_title:m}=s,g=Object(c.a)(s,p),f=n.replace("{text}",d||"").replace("{question_title}",m||""),b="chat"===this.props.args.api_format||e.includes("/chat/completions"),x=[{type:"function",function:{name:"search_knowledge_base",description:"Search the Lysa knowledge base for customer support information",parameters:{type:"object",properties:{query:{type:"string",description:"Search query to find relevant information"}},required:["query"]}}}];let y;if(b){const t={};g.model&&(t.model=g.model),g.max_tokens&&(t.max_tokens=g.max_tokens),g.temperature&&(t.temperature=g.temperature),g.top_p&&(t.top_p=g.top_p),g.stop&&(t.stop=g.stop),y=Object(a.a)(Object(a.a)({messages:[{role:"user",content:f}]},t),{},{tools:x,tool_choice:"auto",stream:!1})}else y=Object(a.a)(Object(a.a)({prompt:f},g),{},{echo:!1});const _={"Content-Type":"application/json"};i&&(_.Authorization="Bearer ".concat(i));try{var w,C;this.setState(t=>({totalRequests:t.totalRequests+1}));const o=await fetch(e,{method:"POST",headers:_,body:JSON.stringify(y),signal:this.abortController.signal});if(!o.ok){const t=await o.text();throw console.error("API Error Response:",t),this.setState(t=>({failedRequests:t.failedRequests+1})),new Error("HTTP error! status: ".concat(o.status))}this.setState(t=>({requestsThisMinute:t.requestsThisMinute+1,successfulRequests:t.successfulRequests+1}));const s=await o.json(),n=(null===(w=s.usage)||void 0===w?void 0:w.prompt_tokens)||0,r=(null===(C=s.usage)||void 0===C?void 0:C.completion_tokens)||0,i=this.props.args.token_cost||.05,a=this.props.args.output_token_cost||.1,c=n||Math.ceil(f.length/4),l=c/1e6*i,u=(r||0)/1e6*a;this.setState(t=>({inputCost:t.inputCost+l,outputCost:t.outputCost+u,totalCost:t.totalCost+l+u}));let p="",h=null;if(b&&s.choices&&s.choices[0]&&s.choices[0].message)h=s.choices[0].message,p=h.content||"";else{if(!(s.choices&&s.choices[0]&&s.choices[0].text))return console.error("Unexpected response format:",s),"";p=s.choices[0].text}if(console.log("Full AI Response:",p),b&&h&&h.tool_calls&&h.tool_calls.length>0){console.log("Tool calls detected:",h.tool_calls);const o=await this.executeToolCalls(h.tool_calls);console.log("Tool execution results:",o);return await this.makeFollowUpCall(e,t,o)}let d="";const m=p.indexOf("<answer>");if(-1!==m){d=p.substring(m+8);const t=d.indexOf("</answer>");-1!==t&&(d=d.substring(0,t))}else d=p;return console.log("Extracted Answer:",d),d}catch(T){return T instanceof Error&&"AbortError"===T.name||console.error("Error decoding response",T),""}}}componentDidUpdate(){this.userTextarea&&this.suggestionTextarea&&(this.suggestionTextarea.scrollTop=this.userTextarea.scrollTop)}componentWillUnmount(){null!==this.state.debounceTimer&&window.clearTimeout(this.state.debounceTimer)}}var d=Object(l.c)(h);i.a.render(n.a.createElement(n.a.StrictMode,null,n.a.createElement(d,null)),document.getElementById("root"))},7:function(t,e,o){t.exports=o(14)}},[[7,1,2]]]);
//# sourceMappingURL=main.bd9b942e.chunk.js.map