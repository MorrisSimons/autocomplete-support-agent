(this.webpackJsonpstreamlit_copilot=this.webpackJsonpstreamlit_copilot||[]).push([[0],{14:function(e,t,o){"use strict";o.r(t);var s=o(1),n=o.n(s),r=o(5),i=o.n(r),a=o(0),l=o(2),c=o(3);const u=["prompt_template","api_key","height","fontFamily","border","text","question_title"],p=["prompt_template","api_url","api_key","height","fontFamily","border","text","question_title"];class h extends c.b{constructor(){super(...arguments),this.userTextarea=null,this.suggestionTextarea=null,this.state={text:"",suggestion:"",isFocused:!1,textAreaIsFocused:!1,requestsThisMinute:0,currentMinute:Math.floor(Date.now()/6e4),totalRequests:0,successfulRequests:0,failedRequests:0,inputCost:0,outputCost:0,totalCost:0,debounceTimer:null},this.render=()=>{const{theme:e}=this.props;if(!e)return n.a.createElement("div",null,"Theme is undefined, please check streamlit version.");const t=this.props.args.height,o=e.font,s=t+"px",r="1px solid "+e.primaryColor,i="1px solid "+e.secondaryBackgroundColor;return n.a.createElement("div",null,n.a.createElement("div",{style:{fontSize:"1em",color:e.textColor,marginBottom:"0.5em",padding:"0.5em",backgroundColor:e.backgroundColor,borderRadius:"0.3em",border:"1px solid "+e.secondaryBackgroundColor,display:"flex",justifyContent:"space-between",alignItems:"center"}},n.a.createElement("div",null,n.a.createElement("strong",null,"API Stats:")," Total: ",this.state.totalRequests," | \u2705 Success: ",this.state.successfulRequests," | \u274c Failed: ",this.state.failedRequests," |","Requests this per minute / limit: ",this.state.requestsThisMinute," / ",this.props.args.rpm_limit,n.a.createElement("br",null),n.a.createElement("strong",null,"Cost:")," Input: $",this.state.inputCost.toFixed(6)," | Output: $",this.state.outputCost.toFixed(6)," | Total: $",this.state.totalCost.toFixed(6)),n.a.createElement("button",{onClick:this.resetCounters,style:{fontSize:"0.7em",padding:"0.2em 0.5em",backgroundColor:e.primaryColor,color:"white",border:"none",borderRadius:"0.3em",cursor:"pointer"},title:"Reset counters"},"\ud83d\udd04 Reset")),n.a.createElement("div",{tabIndex:0,style:{height:s,width:"auto",border:this.state.isFocused?r:i,borderRadius:"0.5em",overflowY:"scroll",overflowX:"hidden",position:"relative",backgroundColor:e.secondaryBackgroundColor},onFocus:this._onFocus,onBlur:this._onBlur},n.a.createElement("textarea",{style:{marginLeft:"0.5em",fontFamily:o,marginTop:"0.2em",whiteSpace:"pre-wrap",width:"calc(100% - 1.2em)",height:"100%",border:"none",outline:"none",position:"absolute",backgroundColor:"transparent",color:"light"===e.base?"rgba(41,51,62,0.5)":"rgba(255,255,255,0.5)",padding:"0"},value:this.state.suggestion,readOnly:!0,ref:e=>{this.suggestionTextarea=e}}),n.a.createElement("textarea",{style:{marginLeft:"0.5em",fontFamily:o,marginTop:"0.2em",whiteSpace:"pre-wrap",width:"calc(100% - 1.2em)",height:"100%",border:"none",outline:"none",position:"absolute",backgroundColor:"transparent",color:e.textColor,padding:"0"},value:this.state.text,onChange:this.onChange,onKeyDown:this.onKeyDown,onBlur:this._onTextAreaBlur,onScroll:this.onScroll,ref:e=>{this.userTextarea=e}})))},this.onScroll=()=>{this.forceUpdate()},this.onChange=e=>{const t=e.target.value;this.setState({text:t,suggestion:""}),null!==this.state.debounceTimer&&window.clearTimeout(this.state.debounceTimer);const o=window.setTimeout(()=>{if(""!==t.trim()){const e=this.props.args.api_url;this.callApi(t,e).then(e=>{""!==this.state.text.trim()&&this.setState({suggestion:this.state.text+e})})}},500);this.setState({debounceTimer:o})},this.onKeyDown=e=>{"Tab"===e.key&&(e.preventDefault(),this.setState(e=>({text:e.suggestion,suggestion:""}),()=>{const e={target:{value:this.state.text}};this.onChange(e)}))},this._onTextAreaBlur=()=>{this.setState({textAreaIsFocused:!1},()=>{c.a.setComponentValue(this.state.text),this.setState({suggestion:""})})},this._onFocus=()=>{this.setState({isFocused:!0})},this._onBlur=()=>{this.setState({isFocused:!1})},this.resetCounters=()=>{this.setState({totalRequests:0,successfulRequests:0,failedRequests:0,requestsThisMinute:0,inputCost:0,outputCost:0,totalCost:0})},this.abortController=new AbortController,this.executeToolCalls=async e=>{const t=[];for(const n of e){var o,s;const e=null===(o=n.function)||void 0===o?void 0:o.name,r=JSON.parse((null===(s=n.function)||void 0===s?void 0:s.arguments)||"{}");if(console.log("Executing tool: ".concat(e," with args:"),r),"search_knowledge_base"===e){const o=await this.executeTool(e,r),s=r.query||"unknown query",n='Search Query: "'.concat(s,'"\n\n').concat(o,"\n\nSource: Information retrieved from Lysa's knowledge base via Pinecone vector search.");t.push(n)}else t.push("Unknown tool: ".concat(e))}return t},this.executeTool=async(e,t)=>{if("search_knowledge_base"===e){let e="";e="string"===typeof t.query?t.query:t.query&&"object"===typeof t.query?t.query.toString()||"":String(t.query||""),console.log('Processing query: "'.concat(e,'"'));const s=this.props.args.pinecone_api_key,n=this.props.args.pinecone_index_name,r=this.props.args.openai_api_key;if(s&&n&&r)try{const t=await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{Authorization:"Bearer ".concat(r),"Content-Type":"application/json"},body:JSON.stringify({model:this.props.args.embedding_model||"text-embedding-ada-002",input:e})});if(!t.ok)throw new Error("OpenAI API error: ".concat(t.status));const o=(await t.json()).data[0].embedding,i=(this.props.args.pinecone_environment,this.props.args.pinecone_host||"https://api.pinecone.io");let a;a=i.includes("svc.")&&i.includes(".pinecone.io")?"https://".concat(i,"/query"):"".concat(i,"/indexes/").concat(n,"/query"),console.log("Pinecone query URL: ".concat(a));const l=await fetch(a,{method:"POST",headers:{"Api-Key":s,"Content-Type":"application/json"},body:JSON.stringify({vector:o,topK:this.props.args.search_top||3,includeMetadata:!0})});if(!l.ok)throw new Error("Pinecone API error: ".concat(l.status));const c=await l.json();if(c.matches&&c.matches.length>0){const e=c.matches.map(e=>{var t,o,s,n;return{title:(null===(t=e.metadata)||void 0===t?void 0:t.title)||"No title",source:(null===(o=e.metadata)||void 0===o?void 0:o.source)||"No source",text:(null===(s=e.metadata)||void 0===s?void 0:s.text)||(null===(n=e.metadata)||void 0===n?void 0:n.content)||"No content"}}).filter(e=>"No content"!==e.text);if(e.length>0)return console.log("Found results:",e),JSON.stringify({count:e.length,results:e},null,2)}return""}catch(o){return console.error("Pinecone search error:",o),""}return""}return""},this.makeFollowUpCall=async(e,t,o)=>{console.log(t);const s=["You are an AUTOCOMPLETE assistant for Lysa customer support.","Continue the user's message naturally without any formatting or extra text.","","User's partial message: \"".concat(t,'"'),"","Search Results from Lysa's knowledge base:",o.join("\n\n"),"","RULES:","- You can only autocomplete if it's really needed otherwise don't; just return <done>","- Continue exactly from where the user stopped and finish the sentence naturally","- Answer all questions by searching the knowledge base","",'Continue from "'.concat(t,'" and IMPORTANT: ADD THE SOURCE WITH LINK TO THE CLAIM AT THE END like this: [Source](url)')].join("\n"),n=this.props.args,{prompt_template:r,api_key:i,height:c,fontFamily:p,border:h,text:d,question_title:m}=n,g=Object(l.a)(n,u),f=(r.replace("{text}",d||"").replace("{question_title}",m||""),"chat"===this.props.args.api_format||e.includes("/chat/completions")),b=new AbortController;let y;if(f){const e={};g.model&&(e.model=g.model),g.max_tokens&&(e.max_tokens=g.max_tokens),g.temperature&&(e.temperature=g.temperature),g.top_p&&(e.top_p=g.top_p),g.stop&&(e.stop=g.stop),y=Object(a.a)(Object(a.a)({messages:[{role:"user",content:s}]},e),{},{stream:!1})}else y=Object(a.a)(Object(a.a)({prompt:s},g),{},{echo:!1});const x={"Content-Type":"application/json"};i&&(x.Authorization="Bearer ".concat(i));try{const t=await fetch(e,{method:"POST",headers:x,body:JSON.stringify(y),signal:b.signal});if(!t.ok)throw new Error("HTTP error! status: ".concat(t.status));const o=await t.json();let s="";if(f&&o.choices&&o.choices[0]&&o.choices[0].message)s=o.choices[0].message.content;else{if(!(o.choices&&o.choices[0]&&o.choices[0].text))return console.error("Unexpected response format:",o),"";s=o.choices[0].text}let n="";const r=s.indexOf("<answer>");if(-1!==r){n=s.substring(r+8);const e=n.indexOf("</answer>");-1!==e&&(n=n.substring(0,e))}else n=s;return n}catch(w){return console.error("Follow-up call error:",w),""}},this.callApi=async(e,t)=>{if(this.abortController.abort(),this.abortController=new AbortController,""===e.trim())return"";const o=Math.floor(Date.now()/6e4);if(o>this.state.currentMinute)this.setState({currentMinute:o,requestsThisMinute:0});else if(this.state.requestsThisMinute>this.props.args.rpm_limit)return new Promise(o=>{setTimeout(()=>{o(this.callApi(e,t))},1e3)});const s=this.props.args,{prompt_template:n,api_url:r,api_key:i,height:c,fontFamily:u,border:h,text:d,question_title:m}=s,g=Object(l.a)(s,p),f=n.replace("{text}",e).replace("{question_title}",m||""),b="chat"===this.props.args.api_format||t.includes("/chat/completions"),y=[{type:"function",function:{name:"search_knowledge_base",description:"S\xf6k i Lysas kunskapsbas efter information f\xf6r kundsupport",parameters:{type:"object",properties:{query:{type:"string",description:"S\xf6kfr\xe5ga f\xf6r att hitta relevant information"}},required:["query"]}}}];let x;if(b){const e={};g.model&&(e.model=g.model),g.max_tokens&&(e.max_tokens=g.max_tokens),g.temperature&&(e.temperature=g.temperature),g.top_p&&(e.top_p=g.top_p),g.stop&&(e.stop=g.stop),x=Object(a.a)(Object(a.a)({messages:[{role:"user",content:f}]},e),{},{tools:y,tool_choice:"auto",stream:!1})}else x=Object(a.a)(Object(a.a)({prompt:f},g),{},{echo:!1});const w={"Content-Type":"application/json"};i&&(w.Authorization="Bearer ".concat(i));try{var _,T;this.setState(e=>({totalRequests:e.totalRequests+1}));const o=await fetch(t,{method:"POST",headers:w,body:JSON.stringify(x),signal:this.abortController.signal});if(!o.ok){const e=await o.text();throw console.error("API Error Response:",e),this.setState(e=>({failedRequests:e.failedRequests+1})),new Error("HTTP error! status: ".concat(o.status))}this.setState(e=>({requestsThisMinute:e.requestsThisMinute+1,successfulRequests:e.successfulRequests+1}));const s=await o.json(),n=(null===(_=s.usage)||void 0===_?void 0:_.prompt_tokens)||0,r=(null===(T=s.usage)||void 0===T?void 0:T.completion_tokens)||0,i=this.props.args.token_cost||.05,a=this.props.args.output_token_cost||.1,l=n||Math.ceil(f.length/4),c=l/1e6*i,u=(r||0)/1e6*a;this.setState(e=>({inputCost:e.inputCost+c,outputCost:e.outputCost+u,totalCost:e.totalCost+c+u}));let p="",h=null;if(b&&s.choices&&s.choices[0]&&s.choices[0].message)h=s.choices[0].message,p=h.content||"";else{if(!(s.choices&&s.choices[0]&&s.choices[0].text))return console.error("Unexpected response format:",s),"";p=s.choices[0].text}if(console.log("Full AI Response:",p),b&&h&&h.tool_calls&&h.tool_calls.length>0){console.log("Tool calls detected:",h.tool_calls);const o=await this.executeToolCalls(h.tool_calls);console.log("Tool execution results:",o);const s=await this.makeFollowUpCall(t,e,o);let n="";const r=s.indexOf("<answer>");if(-1!==r){n=s.substring(r+8);const e=n.indexOf("</answer>");-1!==e&&(n=n.substring(0,e))}else{const e=s.indexOf("<think>");if(-1!==e){const t=s.indexOf("</think>");n=-1!==t?s.substring(t+8).trim():s.substring(e+7).trim()}else n=s}return n=n.replace(/<think>[\s\S]*?<\/think>/g,"").trim(),console.log("Extracted Answer from follow-up:",n),n}let d="";const m=p.indexOf("<answer>");if(-1!==m){d=p.substring(m+8);const e=d.indexOf("</answer>");-1!==e&&(d=d.substring(0,e))}else d=p;return console.log("Extracted Answer:",d),d}catch(C){return C instanceof Error&&"AbortError"===C.name||console.error("Error decoding response",C),""}}}componentDidUpdate(){this.userTextarea&&this.suggestionTextarea&&(this.suggestionTextarea.scrollTop=this.userTextarea.scrollTop)}componentWillUnmount(){null!==this.state.debounceTimer&&window.clearTimeout(this.state.debounceTimer)}}var d=Object(c.c)(h);i.a.render(n.a.createElement(n.a.StrictMode,null,n.a.createElement(d,null)),document.getElementById("root"))},7:function(e,t,o){e.exports=o(14)}},[[7,1,2]]]);
//# sourceMappingURL=main.f9a33ec3.chunk.js.map