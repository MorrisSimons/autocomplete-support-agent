(this.webpackJsonpstreamlit_copilot=this.webpackJsonpstreamlit_copilot||[]).push([[0],{14:function(t,e,s){"use strict";s.r(e);var o=s(1),r=s.n(o),n=s(5),a=s.n(n),i=s(0),l=s(2),c=s(3);const u=["prompt_template","api_key","height","fontFamily","border","text","question_title"],p=["prompt_template","api_url","api_key","height","fontFamily","border","text","question_title"];class h extends c.b{constructor(){super(...arguments),this.userTextarea=null,this.suggestionTextarea=null,this.state={text:"",suggestion:"",isFocused:!1,textAreaIsFocused:!1,requestsThisMinute:0,currentMinute:Math.floor(Date.now()/6e4),totalRequests:0,successfulRequests:0,failedRequests:0,inputCost:0,outputCost:0,totalCost:0,debounceTimer:null},this.render=()=>{const{theme:t}=this.props;if(!t)return r.a.createElement("div",null,"Theme is undefined, please check streamlit version.");const e=this.props.args.height,s=t.font,o=e+"px",n="1px solid "+t.primaryColor,a="1px solid "+t.secondaryBackgroundColor;return r.a.createElement("div",null,r.a.createElement("div",{style:{fontSize:"1em",color:t.textColor,marginBottom:"0.5em",padding:"0.5em",backgroundColor:t.backgroundColor,borderRadius:"0.3em",border:"1px solid "+t.secondaryBackgroundColor,display:"flex",justifyContent:"space-between",alignItems:"center"}},r.a.createElement("div",null,r.a.createElement("strong",null,"API Stats:")," Total: ",this.state.totalRequests," | \u2705 Success: ",this.state.successfulRequests," | \u274c Failed: ",this.state.failedRequests," |","Requests this per minute / limit: ",this.state.requestsThisMinute," / ",this.props.args.rpm_limit,r.a.createElement("br",null),r.a.createElement("strong",null,"Cost:")," Input: $",this.state.inputCost.toFixed(6)," | Output: $",this.state.outputCost.toFixed(6)," | Total: $",this.state.totalCost.toFixed(6)),r.a.createElement("button",{onClick:this.resetCounters,style:{fontSize:"0.7em",padding:"0.2em 0.5em",backgroundColor:t.primaryColor,color:"white",border:"none",borderRadius:"0.3em",cursor:"pointer"},title:"Reset counters"},"\ud83d\udd04 Reset")),r.a.createElement("div",{tabIndex:0,style:{height:o,width:"auto",border:this.state.isFocused?n:a,borderRadius:"0.5em",overflowY:"scroll",overflowX:"hidden",position:"relative",backgroundColor:t.secondaryBackgroundColor},onFocus:this._onFocus,onBlur:this._onBlur},r.a.createElement("textarea",{style:{marginLeft:"0.5em",fontFamily:s,marginTop:"0.2em",whiteSpace:"pre-wrap",width:"calc(100% - 1.2em)",height:"100%",border:"none",outline:"none",position:"absolute",backgroundColor:"transparent",color:"light"===t.base?"rgba(41,51,62,0.5)":"rgba(255,255,255,0.5)",padding:"0"},value:this.state.suggestion,readOnly:!0,ref:t=>{this.suggestionTextarea=t}}),r.a.createElement("textarea",{style:{marginLeft:"0.5em",fontFamily:s,marginTop:"0.2em",whiteSpace:"pre-wrap",width:"calc(100% - 1.2em)",height:"100%",border:"none",outline:"none",position:"absolute",backgroundColor:"transparent",color:t.textColor,padding:"0"},value:this.state.text,onChange:this.onChange,onKeyDown:this.onKeyDown,onBlur:this._onTextAreaBlur,onScroll:this.onScroll,ref:t=>{this.userTextarea=t}})))},this.onScroll=()=>{this.forceUpdate()},this.onChange=t=>{const e=t.target.value;this.setState({text:e,suggestion:""}),null!==this.state.debounceTimer&&window.clearTimeout(this.state.debounceTimer);const s=window.setTimeout(()=>{if(""!==e.trim()){const t=this.props.args.api_url;this.callApi(e,t).then(t=>{""!==this.state.text.trim()&&this.setState({suggestion:this.state.text+t})})}},500);this.setState({debounceTimer:s})},this.onKeyDown=t=>{"Tab"===t.key&&(t.preventDefault(),this.setState(t=>({text:t.suggestion,suggestion:""}),()=>{const t={target:{value:this.state.text}};this.onChange(t)}))},this._onTextAreaBlur=()=>{this.setState({textAreaIsFocused:!1},()=>{c.a.setComponentValue(this.state.text),this.setState({suggestion:""})})},this._onFocus=()=>{this.setState({isFocused:!0})},this._onBlur=()=>{this.setState({isFocused:!1})},this.resetCounters=()=>{this.setState({totalRequests:0,successfulRequests:0,failedRequests:0,requestsThisMinute:0,inputCost:0,outputCost:0,totalCost:0})},this.abortController=new AbortController,this.executeToolCalls=async t=>{const e=[];for(const r of t){var s,o;const t=null===(s=r.function)||void 0===s?void 0:s.name,n=JSON.parse((null===(o=r.function)||void 0===o?void 0:o.arguments)||"{}");if(console.log("Executing tool: ".concat(t," with args:"),n),"search_knowledge_base"===t){const s=this.getMockToolResult(t,n);e.push(s)}else e.push("Unknown tool: ".concat(t))}return e},this.getMockToolResult=(t,e)=>{if("search_knowledge_base"===t){let t="";t="string"===typeof e.query?e.query:e.query&&"object"===typeof e.query?e.query.toString()||"":String(e.query||"");const s=t.toLowerCase();return console.log('Processing query: "'.concat(t,'" (lowercase: "').concat(s,'")')),s.includes("avgifter")||s.includes("fees")||s.includes("kostnad")?"Lysa charges 0.4% annually for investment accounts":s.includes("sparkonto")||s.includes("interest")||s.includes("r\xe4nta")?"Sparkonto Auto offers 3.5% interest rate":s.includes("pension")?"You can transfer your pension to Lysa with no fees":s.includes("isk")||s.includes("investment")?"ISK accounts have 0.4% annual fee and tax-efficient structure":s.includes("contact")||s.includes("support")||s.includes("help")?"You can contact Lysa support via email at support@lysa.se or call +46 8 123 45 67":'Searching for: "'.concat(t,'". Found general information about Lysa services.')}return"Mock result for ".concat(t)},this.makeFollowUpCall=async(t,e,s)=>{const o="Based on search results: ".concat(s.join("\n"),'\n\nComplete: "').concat(e,'"'),r=this.props.args,{prompt_template:n,api_key:a,height:c,fontFamily:p,border:h,text:d,question_title:m}=r,g=Object(l.a)(r,u),f=(n.replace("{text}",d||"").replace("{question_title}",m||""),"chat"===this.props.args.api_format||t.includes("/chat/completions"));let b;if(f){const t={};g.model&&(t.model=g.model),g.max_tokens&&(t.max_tokens=g.max_tokens),g.temperature&&(t.temperature=g.temperature),g.top_p&&(t.top_p=g.top_p),g.stop&&(t.stop=g.stop),b=Object(i.a)(Object(i.a)({messages:[{role:"user",content:o}]},t),{},{stream:!1})}else b=Object(i.a)(Object(i.a)({prompt:o},g),{},{echo:!1});const x={"Content-Type":"application/json"};a&&(x.Authorization="Bearer ".concat(a));try{const e=await fetch(t,{method:"POST",headers:x,body:JSON.stringify(b),signal:this.abortController.signal});if(!e.ok)throw new Error("HTTP error! status: ".concat(e.status));const s=await e.json();let o="";if(f&&s.choices&&s.choices[0]&&s.choices[0].message)o=s.choices[0].message.content;else{if(!(s.choices&&s.choices[0]&&s.choices[0].text))return console.error("Unexpected response format:",s),"";o=s.choices[0].text}let r="";const n=o.indexOf("<answer>");if(-1!==n){r=o.substring(n+8);const t=r.indexOf("</answer>");-1!==t&&(r=r.substring(0,t))}else r=o;return r}catch(y){return console.error("Follow-up call error:",y),""}},this.callApi=async(t,e)=>{if(this.abortController.abort(),this.abortController=new AbortController,""===t.trim())return"";const s=Math.floor(Date.now()/6e4);if(s>this.state.currentMinute)this.setState({currentMinute:s,requestsThisMinute:0});else if(this.state.requestsThisMinute>this.props.args.rpm_limit)return new Promise(s=>{setTimeout(()=>{s(this.callApi(t,e))},1e3)});const o=this.props.args,{prompt_template:r,api_url:n,api_key:a,height:c,fontFamily:u,border:h,text:d,question_title:m}=o,g=Object(l.a)(o,p),f=r.replace("{text}",d||"").replace("{question_title}",m||""),b="chat"===this.props.args.api_format||e.includes("/chat/completions"),x=[{type:"function",function:{name:"search_knowledge_base",description:"Search the Lysa knowledge base for customer support information",parameters:{type:"object",properties:{query:{type:"string",description:"Search query to find relevant information"}},required:["query"]}}}];let y;if(b){const t={};g.model&&(t.model=g.model),g.max_tokens&&(t.max_tokens=g.max_tokens),g.temperature&&(t.temperature=g.temperature),g.top_p&&(t.top_p=g.top_p),g.stop&&(t.stop=g.stop),y=Object(i.a)(Object(i.a)({messages:[{role:"user",content:f}]},t),{},{tools:x,tool_choice:"auto",stream:!1})}else y=Object(i.a)(Object(i.a)({prompt:f},g),{},{echo:!1});const _={"Content-Type":"application/json"};a&&(_.Authorization="Bearer ".concat(a));try{var w,C;this.setState(t=>({totalRequests:t.totalRequests+1}));const s=await fetch(e,{method:"POST",headers:_,body:JSON.stringify(y),signal:this.abortController.signal});if(!s.ok){const t=await s.text();throw console.error("API Error Response:",t),this.setState(t=>({failedRequests:t.failedRequests+1})),new Error("HTTP error! status: ".concat(s.status))}this.setState(t=>({requestsThisMinute:t.requestsThisMinute+1,successfulRequests:t.successfulRequests+1}));const o=await s.json(),r=(null===(w=o.usage)||void 0===w?void 0:w.prompt_tokens)||0,n=(null===(C=o.usage)||void 0===C?void 0:C.completion_tokens)||0,a=this.props.args.token_cost||.05,i=this.props.args.output_token_cost||.1,l=r||Math.ceil(f.length/4),c=l/1e6*a,u=(n||0)/1e6*i;this.setState(t=>({inputCost:t.inputCost+c,outputCost:t.outputCost+u,totalCost:t.totalCost+c+u}));let p="",h=null;if(b&&o.choices&&o.choices[0]&&o.choices[0].message)h=o.choices[0].message,p=h.content||"";else{if(!(o.choices&&o.choices[0]&&o.choices[0].text))return console.error("Unexpected response format:",o),"";p=o.choices[0].text}if(console.log("Full AI Response:",p),b&&h&&h.tool_calls&&h.tool_calls.length>0){console.log("Tool calls detected:",h.tool_calls);const s=await this.executeToolCalls(h.tool_calls);console.log("Tool execution results:",s);return await this.makeFollowUpCall(e,t,s)}let d="";const m=p.indexOf("<answer>");if(-1!==m){d=p.substring(m+8);const t=d.indexOf("</answer>");-1!==t&&(d=d.substring(0,t))}else d=p;return console.log("Extracted Answer:",d),d}catch(T){return T instanceof Error&&"AbortError"===T.name||console.error("Error decoding response",T),""}}}componentDidUpdate(){this.userTextarea&&this.suggestionTextarea&&(this.suggestionTextarea.scrollTop=this.userTextarea.scrollTop)}componentWillUnmount(){null!==this.state.debounceTimer&&window.clearTimeout(this.state.debounceTimer)}}var d=Object(c.c)(h);a.a.render(r.a.createElement(r.a.StrictMode,null,r.a.createElement(d,null)),document.getElementById("root"))},7:function(t,e,s){t.exports=s(14)}},[[7,1,2]]]);
//# sourceMappingURL=main.35abb179.chunk.js.map