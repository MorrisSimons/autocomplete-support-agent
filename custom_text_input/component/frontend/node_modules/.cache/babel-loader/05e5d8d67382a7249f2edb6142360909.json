{"ast":null,"code":"import _objectSpread from\"/home/morrissimons/Desktop/lysa-support-agent/custom_text_input/component/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _objectWithoutProperties from\"/home/morrissimons/Desktop/lysa-support-agent/custom_text_input/component/frontend/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";const _excluded=[\"api_key\"],_excluded2=[\"prompt_template\",\"api_url\",\"api_key\",\"height\",\"fontFamily\",\"border\",\"text\",\"question_title\"];import{StreamlitComponentBase,withStreamlitConnection,Streamlit}from\"streamlit-component-lib\";import React from\"react\";class Copilot extends StreamlitComponentBase{constructor(){super(...arguments);this.userTextarea=null;this.suggestionTextarea=null;this.state={\"text\":\"\",\"suggestion\":\"\",\"isFocused\":false,'textAreaIsFocused':false,requestsThisMinute:0,currentMinute:Math.floor(Date.now()/60000),totalRequests:0,successfulRequests:0,failedRequests:0,inputCost:0,outputCost:0,totalCost:0,debounceTimer:null};this.render=()=>{const{theme}=this.props;if(!theme){return/*#__PURE__*/React.createElement(\"div\",null,\"Theme is undefined, please check streamlit version.\");}const height_int=this.props.args[\"height\"];const font_fam=theme.font;const f_height=height_int+'px';const f_focused='1px solid '+theme.primaryColor;const f_not_focused='1px solid '+theme.secondaryBackgroundColor;return/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"div\",{style:{fontSize:'1em',color:theme.textColor,marginBottom:'0.5em',padding:'0.5em',backgroundColor:theme.backgroundColor,borderRadius:'0.3em',border:'1px solid '+theme.secondaryBackgroundColor,display:'flex',justifyContent:'space-between',alignItems:'center'}},/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"strong\",null,\"API Stats:\"),\" Total: \",this.state.totalRequests,\" | \\u2705 Success: \",this.state.successfulRequests,\" | \\u274C Failed: \",this.state.failedRequests,\" |\",\"Requests this per minute / limit: \",this.state.requestsThisMinute,\" / \",this.props.args[\"rpm_limit\"],/*#__PURE__*/React.createElement(\"br\",null),/*#__PURE__*/React.createElement(\"strong\",null,\"Cost:\"),\" Input: $\",this.state.inputCost.toFixed(6),\" | Output: $\",this.state.outputCost.toFixed(6),\" | Total: $\",this.state.totalCost.toFixed(6)),/*#__PURE__*/React.createElement(\"button\",{onClick:this.resetCounters,style:{fontSize:'0.7em',padding:'0.2em 0.5em',backgroundColor:theme.primaryColor,color:'white',border:'none',borderRadius:'0.3em',cursor:'pointer'},title:\"Reset counters\"},\"\\uD83D\\uDD04 Reset\")),/*#__PURE__*/React.createElement(\"div\",{tabIndex:0,style:{height:f_height,width:'auto',border:this.state.isFocused?f_focused:f_not_focused,borderRadius:'0.5em',overflowY:'scroll',overflowX:'hidden',position:'relative',backgroundColor:theme.secondaryBackgroundColor},onFocus:this._onFocus,onBlur:this._onBlur},/*#__PURE__*/React.createElement(\"textarea\",{style:{marginLeft:'0.5em',fontFamily:font_fam,marginTop:'0.2em',whiteSpace:'pre-wrap',width:'calc(100% - 1.2em)',height:'100%',border:'none',outline:'none',position:'absolute',backgroundColor:'transparent',color:theme.base==='light'?'rgba(41,51,62,0.5)':'rgba(255,255,255,0.5)',padding:'0'},value:this.state.suggestion,readOnly:true,ref:textarea=>{this.suggestionTextarea=textarea;}}),/*#__PURE__*/React.createElement(\"textarea\",{style:{marginLeft:'0.5em',fontFamily:font_fam,marginTop:'0.2em',whiteSpace:'pre-wrap',width:'calc(100% - 1.2em)',height:'100%',border:'none',outline:'none',position:'absolute',backgroundColor:'transparent',color:theme.textColor,padding:'0'},value:this.state.text,onChange:this.onChange,onKeyDown:this.onKeyDown,onBlur:this._onTextAreaBlur,onScroll:this.onScroll,ref:textarea=>{this.userTextarea=textarea;}})));};this.onScroll=()=>{this.forceUpdate();};this.onChange=event=>{const text=event.target.value;this.setState({text,suggestion:\"\"});// Clear any existing timer\nif(this.state.debounceTimer!==null){window.clearTimeout(this.state.debounceTimer);}// Set a new debounced timer (500ms delay)\nconst timer=window.setTimeout(()=>{if(text.trim()!==\"\"){const api_upl=this.props.args[\"api_url\"];this.callApi(text,api_upl).then(suggestion=>{if(this.state.text.trim()!==\"\"){this.setState({suggestion:this.state.text+suggestion});}});}},500);// Wait 500ms after user stops typing\nthis.setState({debounceTimer:timer});};this.onKeyDown=event=>{if(event.key==='Tab'){event.preventDefault();this.setState(prevState=>({text:prevState.suggestion,suggestion:''}),()=>{// Create a synthetic event and call onChange manually\nconst syntheticEvent={target:{value:this.state.text}};this.onChange(syntheticEvent);});}};this._onTextAreaBlur=()=>{this.setState({textAreaIsFocused:false},()=>{try{Streamlit.setComponentValue(this.state.text);this.setState({suggestion:''});}catch(error){console.warn('Error setting component value:',error);}});};this._onFocus=()=>{this.setState({isFocused:true});};this._onBlur=()=>{this.setState({isFocused:false});};this.resetCounters=()=>{this.setState({totalRequests:0,successfulRequests:0,failedRequests:0,requestsThisMinute:0,inputCost:0,outputCost:0,totalCost:0});};this.handleStreamlitMessages=()=>{try{// Set up message handling if needed\nif(typeof window!=='undefined'&&window.parent){// Component is properly initialized\nconsole.log('Streamlit component initialized successfully');}}catch(error){console.warn('Error handling Streamlit messages:',error);}};this.executeToolCalls=async toolCalls=>{const results=[];for(const toolCall of toolCalls){var _toolCall$function,_toolCall$function2;const functionName=(_toolCall$function=toolCall.function)===null||_toolCall$function===void 0?void 0:_toolCall$function.name;const args=JSON.parse((_toolCall$function2=toolCall.function)===null||_toolCall$function2===void 0?void 0:_toolCall$function2.arguments);if(functionName==='search_knowledge_base'){// Call your actual vector search here\n// For now, we'll simulate a search result\nconst result=await this.simulateVectorSearch(args.query);results.push(result);}}return results;};this.simulateVectorSearch=async query=>{// This is a placeholder for your actual vector search implementation\n// Replace this with your actual vector search logic\nconsole.log(\"Simulating vector search for query: \".concat(query));// Simulate API delay\nawait new Promise(resolve=>setTimeout(resolve,100));// Return mock search results - replace with actual implementation\nreturn\"Search results for \\\"\".concat(query,\"\\\": Based on our knowledge base, this appears to be related to customer fees, investment options, or account management.\");};this.makeFollowUpCall=async(apiUrl,userInput,toolResults)=>{const followUpPrompt=\"Based on search results: \".concat(toolResults.join('\\n'),\"\\n\\nComplete: \\\"\").concat(userInput,\"\\\"\");const _this$props$args=this.props.args,{api_key}=_this$props$args,model_kwargs=_objectWithoutProperties(_this$props$args,_excluded);const payload={messages:[{\"role\":\"user\",\"content\":followUpPrompt}],model:model_kwargs.model||\"gpt-3.5-turbo\",max_tokens:model_kwargs.max_tokens||100,temperature:model_kwargs.temperature||0.7,stream:false};const headers={'Content-Type':'application/json'};if(api_key){headers['Authorization']=\"Bearer \".concat(api_key);}try{const response=await fetch(apiUrl,{method:\"POST\",headers:headers,body:JSON.stringify(payload)});if(!response.ok){throw new Error(\"HTTP error! status: \".concat(response.status));}const responseJson=await response.json();return responseJson.choices[0].message.content;}catch(error){console.error(\"Error in follow-up call:\",error);return\"\";}};this.abortController=new AbortController();this.callApi=async(text,api_upl)=>{// Abort the previous request\nthis.abortController.abort();this.abortController=new AbortController();if(text.trim()===\"\"){return\"\";}const currentMinute=Math.floor(Date.now()/60000);if(currentMinute>this.state.currentMinute){this.setState({currentMinute:currentMinute,requestsThisMinute:0});}else if(this.state.requestsThisMinute>this.props.args[\"rpm_limit\"]){// Retry after 1 second if limit is exceeded\nreturn new Promise(resolve=>{setTimeout(()=>{resolve(this.callApi(text,api_upl));},1000);});}const _this$props$args2=this.props.args,{prompt_template,api_url,api_key,height,fontFamily,border,text:questionText,question_title}=_this$props$args2,model_kwargs=_objectWithoutProperties(_this$props$args2,_excluded2);const prompt=prompt_template.replace(\"{text}\",questionText||\"\").replace(\"{question_title}\",question_title||\"\");// format the prompt with both placeholders\n// Generalize to support both chat and legacy completions APIs, not just Groq\n// Determine if the API expects chat format (messages) or legacy format (prompt)\n// Use a prop or model_kwargs to allow user to specify the format, fallback to auto-detect\nconst isChatApi=this.props.args[\"api_format\"]===\"chat\"||api_upl.includes('/chat/completions');let payload;if(isChatApi){// Use chat completions format for any compatible API\nconst validParams={};if(model_kwargs.model)validParams.model=model_kwargs.model;if(model_kwargs.max_tokens)validParams.max_tokens=model_kwargs.max_tokens;if(model_kwargs.temperature)validParams.temperature=model_kwargs.temperature;if(model_kwargs.top_p)validParams.top_p=model_kwargs.top_p;if(model_kwargs.stop)validParams.stop=model_kwargs.stop;// Add tools for vector search functionality\nconst tools=[{type:\"function\",function:{name:\"search_knowledge_base\",description:\"Search the vector database for customer information and support content\",parameters:{type:\"object\",properties:{query:{type:\"string\",description:\"Search query to find relevant information\"}},required:[\"query\"]}}}];payload=_objectSpread(_objectSpread({messages:[{role:\"user\",content:prompt}]},validParams),{},{tools:tools,tool_choice:\"auto\",stream:false});}else{// Use legacy completions format for other APIs\npayload=_objectSpread(_objectSpread({prompt:prompt},model_kwargs),{},{echo:false});}const headers={'Content-Type':'application/json'};// Add API key if provided\nif(api_key){headers['Authorization']=\"Bearer \".concat(api_key);}try{var _responseJson$usage,_responseJson$usage2;// Increment total requests counter\nthis.setState(prevState=>({totalRequests:prevState.totalRequests+1}));const response=await fetch(api_upl,{method:\"POST\",headers:headers,body:JSON.stringify(payload),signal:this.abortController.signal});if(!response.ok){const errorText=await response.text();console.error(\"API Error Response:\",errorText);// Increment failed requests counter\nthis.setState(prevState=>({failedRequests:prevState.failedRequests+1}));throw new Error(\"HTTP error! status: \".concat(response.status));}this.setState(prevState=>({requestsThisMinute:prevState.requestsThisMinute+1,successfulRequests:prevState.successfulRequests+1}));const responseJson=await response.json();// Calculate costs based on token usage\nconst inputTokens=((_responseJson$usage=responseJson.usage)===null||_responseJson$usage===void 0?void 0:_responseJson$usage.prompt_tokens)||0;const outputTokens=((_responseJson$usage2=responseJson.usage)===null||_responseJson$usage2===void 0?void 0:_responseJson$usage2.completion_tokens)||0;const inputPrice=this.props.args[\"token_cost\"]||0.05;const outputPrice=this.props.args[\"output_token_cost\"]||0.10;// If no usage info, estimate based on text length (rough approximation)\nconst estimatedInputTokens=inputTokens||Math.ceil(prompt.length/4);const estimatedOutputTokens=outputTokens||0;const newInputCost=estimatedInputTokens/1000000*inputPrice;const newOutputCost=estimatedOutputTokens/1000000*outputPrice;this.setState(prevState=>({inputCost:prevState.inputCost+newInputCost,outputCost:prevState.outputCost+newOutputCost,totalCost:prevState.totalCost+newInputCost+newOutputCost}));// Handle both chat completions and legacy completions formats\nlet fullResponse=\"\";let message=null;if(isChatApi&&responseJson.choices&&responseJson.choices[0]&&responseJson.choices[0].message){message=responseJson.choices[0].message;fullResponse=message.content||\"\";}else if(responseJson.choices&&responseJson.choices[0]&&responseJson.choices[0].text){fullResponse=responseJson.choices[0].text;}else{console.error(\"Unexpected response format:\",responseJson);return\"\";}// Check if there are tool calls that need to be executed\nif(isChatApi&&message&&message.tool_calls&&message.tool_calls.length>0){console.log(\"Tool calls detected:\",message.tool_calls);// Execute the tool calls\nconst toolResults=await this.executeToolCalls(message.tool_calls);// Make a follow-up call with the tool results\nconst finalResponse=await this.makeFollowUpCall(api_upl,text,toolResults);if(finalResponse){return finalResponse;}}// Log the full response to console (this will show the thinking process)\nconsole.log(\"Full AI Response:\",fullResponse);// Extract only the content after <answer> tag\nlet extractedAnswer=\"\";const answerTagIndex=fullResponse.indexOf(\"<answer>\");if(answerTagIndex!==-1){extractedAnswer=fullResponse.substring(answerTagIndex+8);// 8 is the length of \"<answer>\"\n// Remove any trailing tags or extra content\nconst endTagIndex=extractedAnswer.indexOf(\"</answer>\");if(endTagIndex!==-1){extractedAnswer=extractedAnswer.substring(0,endTagIndex);}}else{// If no <answer> tag found, return the full response\nextractedAnswer=fullResponse;}// Log the extracted answer for debugging\nconsole.log(\"Extracted Answer:\",extractedAnswer);return extractedAnswer;}catch(error){if(error instanceof Error&&error.name==='AbortError'){return\"\";// Return empty string if request was aborted\n}console.error(\"Error decoding response\",error);return\"\";}};}componentDidUpdate(){if(this.userTextarea&&this.suggestionTextarea){this.suggestionTextarea.scrollTop=this.userTextarea.scrollTop;}// Update frame height when component updates\ntry{Streamlit.setFrameHeight();}catch(error){console.warn('Error updating frame height:',error);}}// Initialize component when it mounts\ncomponentDidMount(){try{// Register the component with Streamlit\nStreamlit.setFrameHeight();// Set initial component value\nStreamlit.setComponentValue(this.state.text);// Listen for Streamlit messages\nthis.handleStreamlitMessages();}catch(error){console.warn('Error initializing component:',error);}}// Handle Streamlit messages to prevent registration warnings\n// Cleanup timer when component unmounts\ncomponentWillUnmount(){if(this.state.debounceTimer!==null){window.clearTimeout(this.state.debounceTimer);}}}export default withStreamlitConnection(Copilot);","map":{"version":3,"names":["StreamlitComponentBase","withStreamlitConnection","Streamlit","React","Copilot","userTextarea","suggestionTextarea","state","requestsThisMinute","currentMinute","Math","floor","Date","now","totalRequests","successfulRequests","failedRequests","inputCost","outputCost","totalCost","debounceTimer","render","theme","props","height_int","args","font_fam","font","f_height","f_focused","primaryColor","f_not_focused","secondaryBackgroundColor","fontSize","color","textColor","marginBottom","padding","backgroundColor","borderRadius","border","display","justifyContent","alignItems","toFixed","resetCounters","cursor","height","width","isFocused","overflowY","overflowX","position","_onFocus","_onBlur","marginLeft","fontFamily","marginTop","whiteSpace","outline","base","suggestion","textarea","text","onChange","onKeyDown","_onTextAreaBlur","onScroll","forceUpdate","event","target","value","setState","window","clearTimeout","timer","setTimeout","trim","api_upl","callApi","then","key","preventDefault","prevState","syntheticEvent","textAreaIsFocused","setComponentValue","error","console","warn","handleStreamlitMessages","parent","log","executeToolCalls","toolCalls","results","toolCall","functionName","function","name","JSON","parse","arguments","result","simulateVectorSearch","query","push","Promise","resolve","makeFollowUpCall","apiUrl","userInput","toolResults","followUpPrompt","join","api_key","model_kwargs","payload","messages","model","max_tokens","temperature","stream","headers","response","fetch","method","body","stringify","ok","Error","status","responseJson","json","choices","message","content","abortController","AbortController","abort","prompt_template","api_url","questionText","question_title","prompt","replace","isChatApi","includes","validParams","top_p","stop","tools","type","description","parameters","properties","required","role","tool_choice","echo","signal","errorText","inputTokens","usage","prompt_tokens","outputTokens","completion_tokens","inputPrice","outputPrice","estimatedInputTokens","ceil","length","estimatedOutputTokens","newInputCost","newOutputCost","fullResponse","tool_calls","finalResponse","extractedAnswer","answerTagIndex","indexOf","substring","endTagIndex","componentDidUpdate","scrollTop","setFrameHeight","componentDidMount","componentWillUnmount"],"sources":["/home/morrissimons/Desktop/lysa-support-agent/custom_text_input/component/frontend/src/streamlit_copilot.tsx"],"sourcesContent":["import {\n  StreamlitComponentBase,\n  withStreamlitConnection,\n  Streamlit,\n} from \"streamlit-component-lib\"\nimport React, { ReactNode } from \"react\"\n\ninterface State {\n  text: string\n  suggestion: string\n  isFocused: boolean\n  textAreaIsFocused: boolean\n  requestsThisMinute: number\n  currentMinute: number\n  totalRequests: number\n  successfulRequests: number\n  failedRequests: number\n  inputCost: number\n  outputCost: number\n  totalCost: number\n  debounceTimer: number | null\n}\n\nclass Copilot extends StreamlitComponentBase<State> {\n\n  private userTextarea: HTMLTextAreaElement | null = null;\n  private suggestionTextarea: HTMLTextAreaElement | null = null;\n  public state = {\n    \"text\": \"\",\n    \"suggestion\": \"\",\n    \"isFocused\": false,\n    'textAreaIsFocused': false,\n    requestsThisMinute: 0,\n    currentMinute: Math.floor(Date.now() / 60000),\n    totalRequests: 0,\n    successfulRequests: 0,\n    failedRequests: 0,\n    inputCost: 0,\n    outputCost: 0,\n    totalCost: 0,\n    debounceTimer: null\n  }\n\n  public render = (): ReactNode => {\n    const { theme } = this.props\n    if (!theme) {\n      return <div>Theme is undefined, please check streamlit version.</div>\n    }\n    const height_int = this.props.args[\"height\"]\n    const font_fam = theme.font;\n\n    const f_height = height_int + 'px';\n\n    const f_focused = '1px solid ' + theme.primaryColor;\n    const f_not_focused = '1px solid ' + theme.secondaryBackgroundColor;\n\n    return (\n        <div>\n          {/* Request Counter Display */}\n          <div style={{\n            fontSize: '1em',\n            color: theme.textColor,\n            marginBottom: '0.5em',\n            padding: '0.5em',\n            backgroundColor: theme.backgroundColor,\n            borderRadius: '0.3em',\n            border: '1px solid ' + theme.secondaryBackgroundColor,\n            display: 'flex',\n            justifyContent: 'space-between',\n            alignItems: 'center'\n          }}>\n            <div>\n               <strong>API Stats:</strong> Total: {this.state.totalRequests} | \n              ‚úÖ Success: {this.state.successfulRequests} | \n              ‚ùå Failed: {this.state.failedRequests} | \n              {/* Shows how many API requests have been made in the current minute, out of the allowed requests per minute (RPM) limit */}\n              Requests this per minute / limit: {this.state.requestsThisMinute} / {this.props.args[\"rpm_limit\"]} \n              <br />\n              <strong>Cost:</strong> Input: ${this.state.inputCost.toFixed(6)} | Output: ${this.state.outputCost.toFixed(6)} | Total: ${this.state.totalCost.toFixed(6)}\n              \n              \n            </div>\n            <button\n              onClick={this.resetCounters}\n              style={{\n                fontSize: '0.7em',\n                padding: '0.2em 0.5em',\n                backgroundColor: theme.primaryColor,\n                color: 'white',\n                border: 'none',\n                borderRadius: '0.3em',\n                cursor: 'pointer'\n              }}\n              title=\"Reset counters\"\n            >\n              üîÑ Reset\n            </button>\n          </div>\n          \n          <div\n            tabIndex={0}\n            style={\n              {\n                height:f_height,\n                width:'auto',\n                border:this.state.isFocused ? f_focused: f_not_focused,\n                borderRadius:'0.5em',\n                overflowY:'scroll',\n                overflowX:'hidden',\n                position: 'relative',\n                backgroundColor: theme.secondaryBackgroundColor\n              }\n            }\n            onFocus={this._onFocus}\n            onBlur={this._onBlur}\n          >\n            <textarea\n              style={\n                {\n                  marginLeft:'0.5em',\n                  fontFamily:font_fam,\n                  marginTop:'0.2em',\n                  whiteSpace: 'pre-wrap',\n                  width:  'calc(100% - 1.2em)',\n                  height: '100%',\n                  border: 'none',\n                  outline: 'none',\n                  position: 'absolute',\n                  backgroundColor: 'transparent',\n                  color: theme.base === 'light' ? 'rgba(41,51,62,0.5)' : 'rgba(255,255,255,0.5)',\n                  padding: '0'\n                }\n              }\n              value={this.state.suggestion}\n              readOnly\n              ref={(textarea) => { this.suggestionTextarea = textarea; }}\n            />\n            <textarea\n              style={\n              {\n                marginLeft:'0.5em',\n                fontFamily:font_fam,\n                marginTop:'0.2em',\n                whiteSpace: 'pre-wrap',\n                width:  'calc(100% - 1.2em)',\n                height: '100%',\n                border: 'none',\n                outline: 'none',\n                position: 'absolute',\n                backgroundColor: 'transparent',\n                color:theme.textColor,\n                padding: '0'\n              }\n            }\n              value={this.state.text}\n              onChange={this.onChange}\n              onKeyDown={this.onKeyDown}\n              onBlur={this._onTextAreaBlur}\n              onScroll={this.onScroll}\n              ref={(textarea) => { this.userTextarea = textarea; }}\n            />\n          </div>\n        </div>\n    )\n  }\n\n  public componentDidUpdate(): void {\n    if (this.userTextarea && this.suggestionTextarea) {\n      this.suggestionTextarea.scrollTop = this.userTextarea.scrollTop;\n    }\n    \n    // Update frame height when component updates\n    try {\n      Streamlit.setFrameHeight();\n    } catch (error) {\n      console.warn('Error updating frame height:', error);\n    }\n  }\nprivate onScroll = (): void => {\n    this.forceUpdate();\n  }\n  private onChange = (event: React.ChangeEvent<HTMLTextAreaElement>): void => {\n    const text = event.target.value\n    this.setState({ text, suggestion: \"\" })\n    \n    // Clear any existing timer\n    if (this.state.debounceTimer !== null) {\n      window.clearTimeout(this.state.debounceTimer!)\n    }\n    \n    // Set a new debounced timer (500ms delay)\n    const timer = window.setTimeout(() => {\n      if (text.trim() !== \"\") {\n        const api_upl = this.props.args[\"api_url\"]\n        this.callApi(text, api_upl).then(suggestion => {\n          if (this.state.text.trim() !== \"\") {\n            this.setState({ suggestion: this.state.text + suggestion })\n          }\n        })\n      }\n    }, 500) // Wait 500ms after user stops typing\n    \n    this.setState({ debounceTimer: timer })\n  }\n\n\n  private onKeyDown = (event: React.KeyboardEvent<HTMLTextAreaElement>): void => {\n  if (event.key === 'Tab') {\n    event.preventDefault()\n    this.setState(prevState => ({\n      text: prevState.suggestion,\n      suggestion: ''\n    }), () => {\n      // Create a synthetic event and call onChange manually\n      const syntheticEvent = {\n        target: { value: this.state.text }\n      } as React.ChangeEvent<HTMLTextAreaElement>;\n      this.onChange(syntheticEvent);\n    })\n  }\n}\n\n  private _onTextAreaBlur = (): void => {\n    this.setState({ textAreaIsFocused: false }, () => {\n      try {\n        Streamlit.setComponentValue(this.state.text);\n        this.setState({ suggestion: '' });\n      } catch (error) {\n        console.warn('Error setting component value:', error);\n      }\n    });\n  }\n\n  private _onFocus = (): void => {\n    this.setState({ isFocused: true })\n  }\n\n  private _onBlur = (): void => {\n    this.setState({ isFocused: false })\n  }\n\n  private resetCounters = (): void => {\n    this.setState({\n      totalRequests: 0,\n      successfulRequests: 0,\n      failedRequests: 0,\n      requestsThisMinute: 0,\n      inputCost: 0,\n      outputCost: 0,\n      totalCost: 0\n    });\n  }\n\n  // Initialize component when it mounts\n  componentDidMount(): void {\n    try {\n      // Register the component with Streamlit\n      Streamlit.setFrameHeight();\n      \n      // Set initial component value\n      Streamlit.setComponentValue(this.state.text);\n      \n      // Listen for Streamlit messages\n      this.handleStreamlitMessages();\n    } catch (error) {\n      console.warn('Error initializing component:', error);\n    }\n  }\n\n  // Handle Streamlit messages to prevent registration warnings\n  private handleStreamlitMessages = (): void => {\n    try {\n      // Set up message handling if needed\n      if (typeof window !== 'undefined' && window.parent) {\n        // Component is properly initialized\n        console.log('Streamlit component initialized successfully');\n      }\n    } catch (error) {\n      console.warn('Error handling Streamlit messages:', error);\n    }\n  }\n\n  // Cleanup timer when component unmounts\n  componentWillUnmount(): void {\n    if (this.state.debounceTimer !== null) {\n      window.clearTimeout(this.state.debounceTimer!)\n    }\n  }\n\n  private executeToolCalls = async (toolCalls: any[]): Promise<string[]> => {\n    const results: string[] = [];\n    \n    for (const toolCall of toolCalls) {\n      const functionName = toolCall.function?.name;\n      const args = JSON.parse(toolCall.function?.arguments);\n      \n      if (functionName === 'search_knowledge_base') {\n        // Call your actual vector search here\n        // For now, we'll simulate a search result\n        const result = await this.simulateVectorSearch(args.query);\n        results.push(result);\n      }\n    }\n    \n    return results;\n  }\n\n  private simulateVectorSearch = async (query: string): Promise<string> => {\n    // This is a placeholder for your actual vector search implementation\n    // Replace this with your actual vector search logic\n    console.log(`Simulating vector search for query: ${query}`);\n    \n    // Simulate API delay\n    await new Promise(resolve => setTimeout(resolve, 100));\n    \n    // Return mock search results - replace with actual implementation\n    return `Search results for \"${query}\": Based on our knowledge base, this appears to be related to customer fees, investment options, or account management.`;\n  }\n\n  private makeFollowUpCall = async (apiUrl: string, userInput: string, toolResults: string[]): Promise<string> => {\n    const followUpPrompt = `Based on search results: ${toolResults.join('\\n')}\\n\\nComplete: \"${userInput}\"`;\n    \n    const { api_key, ...model_kwargs } = this.props.args;\n    \n    const payload = {\n      messages: [{\"role\": \"user\", \"content\": followUpPrompt}],\n      model: model_kwargs.model || \"gpt-3.5-turbo\",\n      max_tokens: model_kwargs.max_tokens || 100,\n      temperature: model_kwargs.temperature || 0.7,\n      stream: false\n    };\n    \n    const headers: Record<string, string> = {\n      'Content-Type': 'application/json'\n    };\n    \n    if (api_key) {\n      headers['Authorization'] = `Bearer ${api_key}`;\n    }\n    \n    try {\n      const response = await fetch(apiUrl, {\n        method: \"POST\",\n        headers: headers,\n        body: JSON.stringify(payload)\n      });\n      \n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n      \n      const responseJson = await response.json();\n      return responseJson.choices[0].message.content;\n    } catch (error) {\n      console.error(\"Error in follow-up call:\", error);\n      return \"\";\n    }\n  }\n\n  private abortController = new AbortController();\n\nprivate callApi = async (text: string, api_upl: string): Promise<string> => {\n  // Abort the previous request\n  this.abortController.abort();\n  this.abortController = new AbortController();\n\n  if (text.trim() === \"\") {\n    return \"\";\n  }\n\n  const currentMinute = Math.floor(Date.now() / 60000);\n  if (currentMinute > this.state.currentMinute) {\n    this.setState({\n      currentMinute: currentMinute,\n      requestsThisMinute: 0\n    });\n  } else if (this.state.requestsThisMinute > this.props.args[\"rpm_limit\"]) {\n    // Retry after 1 second if limit is exceeded\n    return new Promise((resolve) => {\n      setTimeout(() => {\n        resolve(this.callApi(text, api_upl));\n      }, 1000);\n    });\n  }\n\n  const {prompt_template, api_url, api_key, height, fontFamily, border, text: questionText, question_title, ...model_kwargs} = this.props.args;\n  const prompt = prompt_template\n    .replace(\"{text}\", questionText || \"\")\n    .replace(\"{question_title}\", question_title || \"\"); // format the prompt with both placeholders\n  \n  // Generalize to support both chat and legacy completions APIs, not just Groq\n  // Determine if the API expects chat format (messages) or legacy format (prompt)\n  // Use a prop or model_kwargs to allow user to specify the format, fallback to auto-detect\n  const isChatApi = (\n    this.props.args[\"api_format\"] === \"chat\" ||\n    api_upl.includes('/chat/completions')\n  );\n\n  let payload;\n  if (isChatApi) {\n    // Use chat completions format for any compatible API\n    const validParams: any = {};\n    if (model_kwargs.model) validParams.model = model_kwargs.model;\n    if (model_kwargs.max_tokens) validParams.max_tokens = model_kwargs.max_tokens;\n    if (model_kwargs.temperature) validParams.temperature = model_kwargs.temperature;\n    if (model_kwargs.top_p) validParams.top_p = model_kwargs.top_p;\n    if (model_kwargs.stop) validParams.stop = model_kwargs.stop;\n\n    // Add tools for vector search functionality\n    const tools = [\n      {\n        type: \"function\",\n        function: {\n          name: \"search_knowledge_base\",\n          description: \"Search the vector database for customer information and support content\",\n          parameters: {\n            type: \"object\",\n            properties: {\n              query: {\n                type: \"string\",\n                description: \"Search query to find relevant information\"\n              }\n            },\n            required: [\"query\"]\n          }\n        }\n      }\n    ];\n\n    payload = {\n      messages: [\n        {\n          role: \"user\",\n          content: prompt\n        }\n      ],\n      ...validParams,\n      tools: tools,\n      tool_choice: \"auto\",\n      stream: false\n    };\n  } else {\n    // Use legacy completions format for other APIs\n    payload = {\n      prompt: prompt,\n      ...model_kwargs,\n      echo: false\n    };\n  }\n  \n  const headers: Record<string, string> = {\n    'Content-Type': 'application/json'\n  };\n  \n  // Add API key if provided\n  if (api_key) {\n    headers['Authorization'] = `Bearer ${api_key}`;\n  }\n\n  try {\n    // Increment total requests counter\n    this.setState(prevState => ({\n      totalRequests: prevState.totalRequests + 1\n    }));\n    \n    const response = await fetch(api_upl, {\n      method: \"POST\",\n      headers: headers,\n      body: JSON.stringify(payload),\n      signal: this.abortController.signal\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error(\"API Error Response:\", errorText);\n      \n      // Increment failed requests counter\n      this.setState(prevState => ({\n        failedRequests: prevState.failedRequests + 1\n      }));\n      \n      throw new Error(`HTTP error! status: ${response.status}`);\n    }\n\n    this.setState(prevState => ({\n      requestsThisMinute: prevState.requestsThisMinute + 1,\n      successfulRequests: prevState.successfulRequests + 1\n    }));\n\n    const responseJson = await response.json();\n    \n    // Calculate costs based on token usage\n    const inputTokens = responseJson.usage?.prompt_tokens || 0;\n    const outputTokens = responseJson.usage?.completion_tokens || 0;\n    \n    const inputPrice = this.props.args[\"token_cost\"] || 0.05;\n    const outputPrice = this.props.args[\"output_token_cost\"] || 0.10;\n    \n    // If no usage info, estimate based on text length (rough approximation)\n    const estimatedInputTokens = inputTokens || Math.ceil(prompt.length / 4);\n    const estimatedOutputTokens = outputTokens || 0;\n    \n    const newInputCost = (estimatedInputTokens / 1_000_000) * inputPrice;\n    const newOutputCost = (estimatedOutputTokens / 1_000_000) * outputPrice;\n    \n    this.setState(prevState => ({\n      inputCost: prevState.inputCost + newInputCost,\n      outputCost: prevState.outputCost + newOutputCost,\n      totalCost: prevState.totalCost + newInputCost + newOutputCost\n    }));\n    \n    // Handle both chat completions and legacy completions formats\n    let fullResponse = \"\";\n    let message = null;\n    \n    if (isChatApi && responseJson.choices && responseJson.choices[0] && responseJson.choices[0].message) {\n      message = responseJson.choices[0].message;\n      fullResponse = message.content || \"\";\n    } else if (responseJson.choices && responseJson.choices[0] && responseJson.choices[0].text) {\n      fullResponse = responseJson.choices[0].text;\n    } else {\n      console.error(\"Unexpected response format:\", responseJson);\n      return \"\";\n    }\n    \n    // Check if there are tool calls that need to be executed\n    if (isChatApi && message && message.tool_calls && message.tool_calls.length > 0) {\n      console.log(\"Tool calls detected:\", message.tool_calls);\n      \n      // Execute the tool calls\n      const toolResults = await this.executeToolCalls(message.tool_calls);\n      \n      // Make a follow-up call with the tool results\n      const finalResponse = await this.makeFollowUpCall(api_upl, text, toolResults);\n      \n      if (finalResponse) {\n        return finalResponse;\n      }\n    }\n    \n    // Log the full response to console (this will show the thinking process)\n    console.log(\"Full AI Response:\", fullResponse);\n    \n    // Extract only the content after <answer> tag\n    let extractedAnswer = \"\";\n    const answerTagIndex = fullResponse.indexOf(\"<answer>\");\n    if (answerTagIndex !== -1) {\n      extractedAnswer = fullResponse.substring(answerTagIndex + 8); // 8 is the length of \"<answer>\"\n      // Remove any trailing tags or extra content\n      const endTagIndex = extractedAnswer.indexOf(\"</answer>\");\n      if (endTagIndex !== -1) {\n        extractedAnswer = extractedAnswer.substring(0, endTagIndex);\n      }\n    } else {\n      // If no <answer> tag found, return the full response\n      extractedAnswer = fullResponse;\n    }\n    \n    // Log the extracted answer for debugging\n    console.log(\"Extracted Answer:\", extractedAnswer);\n    \n    return extractedAnswer;\n  } catch (error) {\n    if (error instanceof Error && error.name === 'AbortError') {\n      return \"\";  // Return empty string if request was aborted\n    }\n    console.error(\"Error decoding response\", error);\n    return \"\";\n  }\n}\n}\n\nexport default withStreamlitConnection(Copilot)\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}